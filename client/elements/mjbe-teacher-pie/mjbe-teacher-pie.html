<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="mjbe-teacher-pie">
  <template>
    <style>
    :host {
      display: block;
    }
    
    #chart-container{
      position: absolute;
      top: 80px;
      margin: 20px;
    }
    </style>


        <div id="holder"><h1>Subjects</h1></div>

        <figure id="chart-container"></figure>

        <paper-dropdown-menu label="Classes">
          <paper-menu class="dropdown-content">
            <template is="dom-repeat" items="[[parsedSkills]]">
            <paper-item>[[item.name]]</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
<!--         <google-chart
          type='column'
          options='{"title": "Class Progress"}'
          cols='[{"label":"Subject", "type":"string"}, {"label":"Class completion", "type":"number"}]'
          rows='[["Addition", 80],["Subtraction", 70],["Division", 90], ["Multiplication", 70]]'>
        </google-chart> -->


  </template>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script>
  'use strict';
  Polymer({
    is: 'mjbe-teacher-pie',
    properties: {
      hoverselection: {
        type: String
      },
      hovercolor: {
        type: String
      },
      hoverbackground: {
        type: String
      },
      userselection: {
        notify: true
      },
      parsedSkills: {
        type: Array,
        computed: 'parseSkills(skills)',
      },
      students: {
        computed: 'parseStudents(loadstudents)',
        // observer: 'drawPie'
      },
      loadstudents: {
        notify: true
      },
      tree: {
        computed: 'parseTree(loadtree)',
      },
      loadtree: {
        notify: true
      },
      active: {
        notify: true
      }
    },
    attached: function() {
      console.log('inside attached')
      var container = document.querySelector('figure#chart-container');
      var attrs = {
          'id': 'col-chart',
          'type': 'column',
          'options':'{"title": "Class Progress"}',
          'cols':'[{"label":"Subject", "type":"string"}, {"label":"Class completion", "type":"number"}]',
          'rows':'[["Addition", 80],["Subtraction", 70],["Division", 90], ["Multiplication", 70]]'
        };
      var chart = document.createElement('google-chart');
      for (var key in attrs) {
        chart.setAttribute(key, attrs[key]);
      }
      container.appendChild(chart);
    },

    clickHandler: function(d) {
      this.userselection = d.data._id;
    },

    parseStudents: function(loadstudents) {
      try {
        console.log(loadstudents, 'this is loadstudents');
        return JSON.parse(loadstudents);
      } catch (e) {}
    },

    parseSkills: function(skills) {
      try {       
        return JSON.parse(skills);
      } catch (e) {}
    },

    drawPie: function() {
      console.log('got a response');
      console.log(this.students);
      var data = this.students;
      var that = this;

      var width = 400,
        height = 400;
      var outerRadius = height / 2 - 20,
        innerRadius = outerRadius / 3,
        cornerRadius = 10;
      var pie = d3.layout.pie()
        .padAngle(.02).value(function(d) {
          return 1;
        });
      var arc = d3.svg.arc()
        .padRadius(outerRadius)
        .innerRadius(innerRadius);
      var svg = d3.select(this.$.holder).append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
      svg.selectAll("path")
        .data(pie(data))
        .enter().append("path")
        .each(function(d) {
          d.outerRadius = outerRadius;
        })
        .attr("d", arc)
        .style("fill", function() {
          var color = '#' + Math.floor(Math.random() * 16777215).toString(16)
          console.log(color);
          return color;
        })
        .on("mouseover", arcTween(outerRadius + 20, 0))
        .on("mouseout", arcTween(outerRadius, 150))
        .on("click", this.clickHandler.bind(this));

      function arcTween(outerRadius, delay) {
        return function() {

          that.hovercolor = d3.select(this)[0][0].style.fill; //get color of current selection
          that.hoverbackground = that.fadeDown(that.hovercolor);
          console.log(that.hovercolor);


          d3.select(this).transition().delay(delay).attrTween("d", function(d) {
            that.hoverselection = d.data.name;

            var i = d3.interpolate(d.outerRadius, outerRadius);
            return function(t) {
              d.outerRadius = i(t);
              return arc(d);
            };
          });
        };
      }
    }
  });
  </script>
</dom-module>
